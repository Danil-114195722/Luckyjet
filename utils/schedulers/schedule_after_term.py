import asyncio
import aioschedule
from datetime import datetime, timedelta
from random import choice

from aiogram.dispatcher import Dispatcher
from aiogram import Bot

from data.config import TOKEN
from utils.keyboard import inline_join_group, inline_buy_rate
from utils.db_connection import select_all_users


bot = Bot(token=TOKEN)
disp = Dispatcher(bot=bot)


async def scheduler():
    all_users = select_all_users()

    for user in all_users:
        now_datetime = datetime.now() - timedelta(hours=3)
        user_id = user[1]

        if not user[2]:
            # print('not reg')
            start_date = datetime.strptime(user[-1], '%Y-%m-%d %H:%M:%S')

            # –ü–†–û–í–ï–†–ö–ê –ù–ê –¢–û, –ß–¢–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–õ–¨ –ë–û–õ–ï–ï 3 –î–ù–ï–ô –ù–ï –ó–ê–†–ï–ì–ê–ù
            # if (((now_datetime - start_date).seconds // 60) % 2 == 1) and (((now_datetime - start_date).seconds // 60) != 1):
            if ((now_datetime - start_date).days % 2 == 1) and ((now_datetime - start_date).days != 1):
                # –ü–û–°–´–õ–ê–ï–ú –°–û–û–ë–©–ï–ù–ò–ï –Æ–ó–ï–†–£

                random_choice = choice([0, 1])
                if random_choice == 0:
                    text = '''‚ùóÔ∏è–î—Ä—É–∂–∏—â–µ, —Ç—ã –±—ã –º–æ–≥ —É–∂–µ —Å–µ–≥–æ–¥–Ω—è –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å üí∞, –Ω–æ –¥–æ —Å–∏—Ö –ø–æ—Ä –Ω–µ –ø—Ä–æ—à—ë–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é!
üî•–°–∫–æ—Ä–µ–µ –∂–º–∏ –∫–Ω–æ–ø–∫—É –ù–ê–ß–ê–¢–¨ –∏ –ø–æ–ª—É—á–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏! –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –∏ —É–∂–µ —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç –ø–æ–ª—É—á–∏—à—å —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —Å–∏–≥–Ω–∞–ª ‚úÖ, –∫–æ—Ç–æ—Ä—ã–π —É–º–Ω–æ–∂–∏—Ç —Ç–≤–æ–∏ –¥–µ–Ω—å–≥–∏ ü§ë'''
                else:
                    text = '''‚ùóÔ∏è–£–∂–µ —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç –¥–∞–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–≥–Ω–∞–ª ‚úÖ –≤ —Å–≤–æ–µ–π –∑–∞–∫—Ä—ã—Ç–æ–π –≥—Ä—É–ø–ø–µ! –ü–æ–ª—É—á–∏—Ç—å –µ–≥–æ –º–æ–∂–µ—Ç –∫–∞–∂–¥—ã–π –∏–∑ –≤–∞—Å üòè –ù–∞–¥–æ –≤—Å–µ–≥–æ –ª–∏—à—å:
1Ô∏è‚É£ –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –ù–ê–ß–ê–¢–¨ –∏ –ø–æ–ª—É—á–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
2Ô∏è‚É£ –ü—Ä–æ–π—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é üòâ
3Ô∏è‚É£ –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –≤ –∑–∞–∫—Ä—ã—Ç—É—é –≥—Ä—É–ø–ø—É üòé
4Ô∏è‚É£ –ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—ã–π —Å–∏–≥–Ω–∞–ª —É–∂–µ —Å–µ–≥–æ–¥–Ω—è ‚úÖ'''
                await bot.send_message(
                    chat_id=user_id,
                    text=text,
                    reply_markup=inline_join_group
                )
                continue

        if user[3] is None and user[2]:
            # print('not pay')
            start_date = datetime.strptime(user[-3], '%Y-%m-%d %H:%M:%S')

            # –ü–†–û–í–ï–†–ö–ê –ù–ê –¢–û, –ß–¢–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–õ–¨ –ë–û–õ–ï–ï 1 –î–ù–Ø –ù–ï –ü–õ–ê–¢–ò–¢ –î–ï–ü–û–ó–ò–¢
            # if ((now_datetime - start_date).seconds // 60) >= 1:
            if (now_datetime - start_date).days >= 1:
                # –ü–û–°–´–õ–ê–ï–ú –°–û–û–ë–©–ï–ù–ò–ï –Æ–ó–ï–†–£

                random_choice = choice([0, 1, 2])
                if random_choice == 0:
                    text = '''–ö–æ–≥–¥–∞ —Ç—ã –≥–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å? –ú–Ω–µ –≤–∞–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–±–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –≤–µ–¥—å —è —Ä–∞–±–æ—Ç–∞—é –Ω–∞–¥ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã –∏ –º–Ω–µ –≤–∞–∂–µ–Ω –∫–∞–∂–¥—ã–π —á–µ–ª–æ–≤–µ–∫!
\n–¢—ã –≥–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è?
–¢–µ–±–µ –æ—Å—Ç–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥, –≤—Å–µ–≥–æ –ª–∏—à—å –æ–ø–ª–∞—Ç–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç –∏ –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å!
–Ø –¥–ª—è –¥–ª—è —ç—Ç–æ–≥–æ —Ç–µ–±–µ –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã!'''
                elif random_choice == 1:
                    text = '''–°–∫–æ—Ä–æ –Ω–∞—á–∞–ª–æ –∏–≥—Ä—ã –ø–æ —Å–∏–≥–Ω–∞–ª–∞–º –≤ –º–æ–µ–π –í–ò–ü –≥—Ä—É–ø–ø–µ!
–¢—ã —Ö–æ—á–µ—à—å —É–∂–µ —Å–µ–≥–æ–¥–Ω—è –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å —Å–≤–æ–∏ –ø–µ—Ä–≤—ã–µ –¥–µ–Ω—å–≥–∏ –≤ –æ–Ω–ª–∞–π–Ω–µ –Ω–µ –≤—Å—Ç–∞–≤–∞—è —Å –¥–∏–≤–∞–Ω–∞?
–Ø –∂–¥—É —Ç–µ–±—è, —Ç–µ–±–µ –æ—Å—Ç–∞–ª—Å—è –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥, –¥–ª—è –Ω–∞—á–∞–ª–∞ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å–æ –º–Ω–æ–π!'''
                else:
                    text = '''–ó–∞ –Ω–µ–¥–µ–ª—é –≤ —Å—Ä–µ–¥–Ω–µ–º –∫–∞–∂–¥—ã–π –º–æ–π –ø–æ–¥–ø–∏—Å—á–∏–∫ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç +400% –∫ —Å–≤–æ–µ–º—É –¥–µ–ø–æ–∑–∏—Ç—É!
–ü—Ä–µ–¥—Å—Ç–∞–≤—å —Å–∫–æ–ª—å–∫–æ —Ç—ã –±—ã —Å–º–æ–≥ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ –≤—ã—Ö–æ–¥—è –∏—Ö –¥–æ–º–∞? –≠—Ç–æ —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞!
–¢–µ–±–µ –æ—Å—Ç–∞–ª—Å—è –≤—Å–µ–≥–æ –æ–¥–∏–Ω —à–∞–≥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–≤–æ–±–æ–¥—ã!
–ù–∞–∂–∏–º–∞–π –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏ –¥–∞–≤–∞–π –Ω–∞—á–Ω–µ–º!'''

                await bot.send_message(
                    chat_id=user_id,
                    text=text,
                    reply_markup=inline_buy_rate
                )
                continue

    await bot.close()


async def main():
    aioschedule.every(1).day.do(scheduler)
    # aioschedule.every(1).minute.do(scheduler)

    while True:
        print('yo')
        await asyncio.create_task(aioschedule.run_pending())
        await asyncio.sleep(3600)
        # await asyncio.sleep(5)


if __name__ == '__main__':
    asyncio.run(main())
